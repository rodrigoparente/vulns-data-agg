# python imports
import logging
from io import BytesIO
from datetime import datetime
from urllib.request import urlopen

# third-party imports
import pandas as pd
import cve_searchsploit as CS

# project imports
from commons.file import save_dict_to_csv

# local imports
from .constants import BASE_URL
from .constants import OUTPUT_FILE_PATH


log = logging.getLogger(__name__)


def download_exploits(update_db=False):

    # update exploitdb database
    if update_db:
        CS.update_db()

    try:
        with urlopen(BASE_URL) as resp:
            exploits = pd.read_csv(BytesIO(resp.read()))
    except Exception as e:
        log.error(f'\tCould not download the file: {e}')

    results = dict()
    for row in exploits.itertuples():
        cves = CS.cve_from_edbid(int(row.id))

        for cveID in cves:

            exploit = {
                'CVE-ID': cveID,
                'exploitName': row.description,
                'exploitPublishedDate': row.date,
                'exploitType': row.type,
                'exploitPlataform': row.platform
            }

            if cveID in results.keys():
                entry = results[cveID]

                saved_date = datetime.strptime(entry.get('exploitPublishedDate'), '%Y-%m-%d')
                curr_date = datetime.strptime(row.date, '%Y-%m-%d')

                if curr_date > saved_date:
                    entry.update(({**exploit}))

                entry['exploitCount'] += 1
            else:
                results.setdefault(cveID, {
                    **exploit,
                    'exploitCount': 1,
                })

    header = ['CVE-ID', 'exploitName', 'exploitPublishedDate',
              'exploitType', 'exploitPlataform', 'exploitCount']
    save_dict_to_csv(OUTPUT_FILE_PATH, header, results)


if __name__ == '__main__':

    print('\nDownloading exploits...')
    download_exploits()
