# python imports
import sys
from io import BytesIO
from datetime import datetime
from urllib.request import urlopen

# third-party imports
import pandas as pd
import cve_searchsploit as CS

# project imports
from commons.file import save_dict_to_csv


def main(exploit_feed, exploit_csv, update_db):

    # update exploitdb database
    if update_db:
        CS.update_db()

    print('Downloading exploits from ExploitDB...')

    try:
        with urlopen(exploit_feed) as resp:
            exploits = pd.read_csv(BytesIO(resp.read()))
    except Exception as e:
        print(f'Could not download the file: {e}')

    results = dict()
    for row in exploits.itertuples():
        cves = CS.cve_from_edbid(int(row.id))

        for cveID in cves:

            exploit = {
                'CVE-ID': cveID,
                'exploitName': row.description,
                'exploitPublishedDate': row.date,
                'exploitType': row.type,
                'exploitPlataform': row.platform
            }

            if cveID in results.keys():
                entry = results[cveID]

                saved_date = datetime.strptime(entry.get('exploitPublishedDate'), '%Y-%m-%d')
                curr_date = datetime.strptime(row.date, '%Y-%m-%d')

                if curr_date > saved_date:
                    entry.update(({**exploit}))

                entry['exploitCount'] += 1
            else:
                results.setdefault(cveID, {
                    **exploit,
                    'exploitCount': 1,
                })

    print('Saving to file...')

    header = ['CVE-ID', 'exploitName', 'exploitPublishedDate',
              'exploitType', 'exploitPlataform', 'exploitCount']
    save_dict_to_csv(exploit_csv, header, results)


if __name__ == '__main__':

    # flag that controls whether to
    # update the exploit base or not
    update = False
    if len(sys.argv) == 2:
        update = True

    main(exploit_feed='https://raw.githubusercontent.com/offensive-security/exploitdb/master/files_exploits.csv',  # noqa
         exploit_csv='output/exploits.csv',
         update_db=update)
